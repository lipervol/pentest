#!/bin/python
import thread,socket,re
def getadd(d):
    a=re.search("Host:(.*)\r\n",d)
    host=a.group(1)
    a=host.split(":")
    if len(a)==1:
        return (a[0],80)
    else:
        return (a[0],int(a[1]))
def client(conn,caddr):
    while 1:
        try:
            data=conn.recv(4096)
            s=socket.socket()
            addr=getadd(data)
            print "[==>]Target:",addr
            s.connect(addr)
            s.sendall(data)
            d=s.recv(40960)
            s.close()
            print "[===]Get data"
            conn.sendall(d)
            print "[<==]Send to client"
        except Exception as e:
            print "Error -_-!",e
            conn.close()
            break
def server(port=1234):
    IP="0.0.0.0"
    s=socket.socket()
    s.bind((IP,port))
    s.listen(5)
    print "[***]Proxy runing ... ..."
    while 1:
        conn,addr=s.accept()
        print "[==>]Connect from ",addr
        thread.start_new_thread(client,(conn,addr))
try:
    server()
except Exception as e:
    print "[***]Error -_-!",e
print "[***]Proxy end"
    
    
    